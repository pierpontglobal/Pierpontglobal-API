<!DOCTYPE html>
<html>

<head>
    <title>Page Title</title>
</head>

<body>
    <script src="/action_cable.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <h1>Terst module for cable configuration</h1>

    <input type="text" id="username">
    <input type="password" id="password">
    <button onclick="authenticate()">Authenticate</button>

    <br>

    <button onclick="get_notifications()">Get admin notifications</button>
    <button onclick="connect_to_background_task()">Backgorund task management</button>

    <br>
    
    <button onclick="window.App.tokenChannel.send_token()">SEND SMS NOTIFICATION</button>
    <input id="code_field" type="text"><button onclick="window.App.tokenChannel.validate_code()">Validate</button>

    <script>

        var host = '0.0.0.0:3000';
        var token = '';

        function authenticate(){
            $.ajax({
                url: `http://${host}/oauth/token`,
                type: 'POST',
                dataType: 'json',
                data: {
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                    grant_type: "password"
                },
                success: function (data){
                    token = data['access_token'];
                    console.log(token)
                },
                error: function (data){
                    console.log(data);
                }
            })
        }

        function connect_to_background_task(){
            window.App = {};
            window.App.cable = ActionCable.createConsumer(`ws://${host}/cable?token=${token}`);
            window.App.tokenChannel = window.App.cable.subscriptions.create({
                channel: 'BackgroundProcessChannel'
            }, {
                connected: () => {
                    console.log(`Connected`);
                },
                disconnected: () => {
                    window.App.tokenChannel.unsubscribe();
                    console.warn(`Disconnected`);
                },
                received: (data) => {
                    console.log(data);
                },
                rejected: () => {
                    console.warn('Rejected!');
                },
                // Custom methods
                kill_worker: function () {
                    return this.perform("kill_worker", {id: 999});
                }
            })
        }

        function get_notifications(){
            window.App = {};
            window.App.cable = ActionCable.createConsumer(`wss://${host}/cable?token=${token}`);
            window.App.tokenChannel = window.App.cable.subscriptions.create({
                channel: 'AdminNotificationChannel',
                token_test: 'Testing token'
            }, {
                connected: () => {
                    console.log(`Connected`);
                    window.App.tokenChannel.retrieve_notifications();
                },
                disconnected: () => {
                    console.warn(`Disconnected`);
                },
                received: (data) => {
                    console.log(data);
                },
                rejected: () => {
                    console.warn('Rejected!');
                },
                // Custom methods
                send_token: function () {
                    return this.perform("send_token");
                },
                validate_code: function() {
                    console.log(document.getElementById('code_field').value);
                    return this.perform("validate_code", {code: document.getElementById('code_field').value});
                    window.App.cable.unsubscribe();
                },
                retrieve_notifications: function(){
                    console.log("Getting notifications...");
                    return this.perform("show_pending");
                }
            })
        }
    </script>
</body>

</html>